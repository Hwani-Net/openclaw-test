<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Street Booth Tycoon - UX Prototype</title>
  <style>
    :root{
      --bg:#fff7fb; --bg2:#eef9ff; --card:rgba(255,255,255,.92); --line:rgba(244,114,182,.25);
      --text:#334155; --muted:#64748b; --cyan:#22d3ee; --pink:#f472b6; --green:#22c55e; --yellow:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1000px 500px at 10% -10%,#fbcfe8aa,transparent 45%),radial-gradient(900px 600px at 110% 20%,#bae6fdaa,transparent 40%),linear-gradient(180deg,var(--bg2),var(--bg));color:var(--text);font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .phone{width:min(430px,100vw);height:100vh;margin:0 auto;display:flex;flex-direction:column;border-left:1px solid #fbcfe8;border-right:1px solid #fbcfe8;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.72));overflow:hidden;box-shadow:0 12px 40px rgba(236,72,153,.15)}
    .top{padding:12px 14px;display:flex;justify-content:space-between;align-items:center;gap:8px;border-bottom:1px solid #fbcfe8;background:rgba(255,255,255,.8)}
    .wallet{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:5px 9px;background:#fff7fb}
    .chip b{color:#0f172a}
    .top-actions{display:flex;gap:6px;align-items:center}
    .shop-btn,.sound-btn{border:1px solid #f472b6;background:linear-gradient(180deg,#f9a8d4,#f472b6);color:#fff;border-radius:12px;padding:8px 10px;font-weight:800;box-shadow:0 6px 16px rgba(236,72,153,.25)}
    .sound-btn{min-width:42px;padding:8px 9px;background:linear-gradient(180deg,#a5f3fc,#67e8f9);border-color:#22d3ee;color:#0e7490}

    .content{flex:1;overflow:auto;padding:12px}
    .screen{display:none;gap:10px}
    .screen.active{display:grid}

    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;backdrop-filter:blur(6px);box-shadow:0 8px 22px rgba(236,72,153,.08)}
    .title{font-weight:900;letter-spacing:.01em}
    .sub{font-size:12px;color:var(--muted)}

    .hero{height:120px;border-radius:14px;background:linear-gradient(120deg,#fbcfe8,#bae6fd);display:flex;align-items:flex-end;padding:10px;border:1px solid #f9a8d4}
    .hero .title{font-size:18px;color:#be185d}

    .offline{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .btn{border:1px solid #cbd5e1;background:#ffffff;color:#334155;border-radius:12px;padding:8px 10px;font-weight:800}
    .btn.primary{background:linear-gradient(180deg,#86efac,#4ade80);border-color:#4ade80;color:#14532d}
    .btn.cyan{background:linear-gradient(180deg,#67e8f9,#22d3ee);border-color:#22d3ee;color:#0e7490}

    .tabs{display:flex;gap:6px;overflow:auto;padding-bottom:2px}
    .tab{flex:0 0 auto;font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid #fbcfe8;color:#7c3aed;background:#fff}
    .tab.active{color:#fff;background:linear-gradient(180deg,#f472b6,#ec4899);border-color:#ec4899;font-weight:800}

    .sku{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border-radius:14px;border:1px solid #fbcfe8;background:#fff}
    .sku .name{font-weight:900;color:#0f172a}
    .tag{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid #fbcfe8;color:#be185d}
    .tag.hot{color:#9a3412;border-color:#fdba74;background:#fed7aa}
    .tag.best{color:#0f766e;border-color:#67e8f9;background:#cffafe}
    .buy{align-self:center;border:1px solid #22d3ee;background:linear-gradient(180deg,#a5f3fc,#67e8f9);color:#0e7490;border-radius:12px;padding:8px 9px;font-weight:900}

    .rank-head{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .select{padding:8px;border-radius:12px;background:#fff;color:#334155;border:1px solid #fbcfe8;font-weight:700}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #fce7f3;text-align:left}
    th{color:#64748b;font-size:11px;text-transform:uppercase;letter-spacing:.06em}

    .bottom{display:grid;grid-template-columns:repeat(3,1fr);border-top:1px solid #fbcfe8;background:#fff}
    .nav{border:none;background:transparent;color:#94a3b8;padding:10px 6px;font-weight:800}
    .nav.active{color:#db2777}

    .modal,.sheet{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.35);z-index:20}
    .modal.show,.sheet.show{display:flex}
    .box{width:min(360px,92vw);background:#fff;border:1px solid #fbcfe8;border-radius:16px;padding:14px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    .sheet{align-items:flex-end}
    .panel{width:min(430px,100vw);background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid #fbcfe8;padding:14px}
    .line{display:flex;justify-content:space-between;margin:6px 0;color:#334155}

    .audio-fab{position:fixed;right:14px;bottom:84px;z-index:70;border:1px solid #22d3ee;background:linear-gradient(180deg,#a5f3fc,#67e8f9);color:#0e7490;border-radius:999px;padding:10px 14px;font-weight:900;box-shadow:0 10px 24px rgba(34,211,238,.35);display:none}
    .audio-fab.show{display:block;animation:pulse 1.6s infinite}

    .card,.sku,.btn,.buy,.tab,.nav,.shop-btn,.sound-btn,.audio-fab{transition:transform .12s ease,box-shadow .2s ease,filter .2s ease}
    .card{animation:floatIn .45s ease}
    .btn:active,.buy:active,.tab:active,.nav:active,.shop-btn:active,.sound-btn:active{transform:scale(.97)}
    .btn:hover,.buy:hover{filter:brightness(1.03)}

    #fxCanvas{position:fixed;inset:0;pointer-events:none;z-index:60}

    @keyframes floatIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,211,238,.45)}70%{box-shadow:0 0 0 16px rgba(34,211,238,0)}100%{box-shadow:0 0 0 0 rgba(34,211,238,0)}}
  </style>
</head>
<body>
  <div class="phone">
    <div class="top">
      <div class="wallet">
        <div class="chip">ì½”ì¸ <b>128,550</b></div>
        <div class="chip">ë¬´ë£Œìºì‹œ <b>480</b></div>
        <div class="chip">ìœ ë£Œìºì‹œ <b>120</b></div>
        <div class="chip" id="apiStatus">API <b>INIT</b></div>
      </div>
      <div class="top-actions">
        <button class="sound-btn" id="soundToggle">ğŸ”Š</button>
        <button class="shop-btn" id="quickShop">SHOP</button>
      </div>
    </div>

    <div class="content">
      <section class="screen active" id="screen-home">
        <div class="hero card">
          <div>
            <div class="title">ğŸ¡ í¬ì°¨íŒ¡ íƒ€ì´ì¿¤</div>
            <div class="sub">ì˜¤ëŠ˜ ë§¤ì¶œ 2,930,000ì› Â· ì¹œêµ¬ë­í‚¹ 14ìœ„</div>
          </div>
        </div>

        <div class="card offline">
          <div>
            <div class="title">ì˜¤í”„ë¼ì¸ ìˆ˜ìµ ë„ì°©</div>
            <div class="sub">ê³¨ë“œ 48,200 / ë¬´ë£Œìºì‹œ +6 (4ì‹œê°„ 20ë¶„ ëˆ„ì )</div>
          </div>
          <div style="display:grid;gap:6px">
            <button class="btn">ë¬´ë£Œ ìˆ˜ë ¹</button>
            <button class="btn cyan" id="btnOffline2x">2ë°° ìˆ˜ë ¹</button>
          </div>
        </div>

        <div class="card">
          <div class="title">ì˜¤ëŠ˜ì˜ ë¯¸ì…˜</div>
          <div class="sub">â€¢ ë¶•ì–´ë¹µ 80ê°œ íŒë§¤ Â· â€¢ ì½¤ë³´ 20íšŒ ë‹¬ì„± Â· â€¢ ì¹œêµ¬ 1ëª… ì´ˆëŒ€</div>
        </div>
      </section>

      <section class="screen" id="screen-shop">
        <div class="tabs" id="shopTabs"></div>
        <div id="shopList" style="display:grid;gap:8px"></div>
      </section>

      <section class="screen" id="screen-rank">
        <div class="rank-head">
          <select class="select" id="scopeSel">
            <option value="world">ì›”ë“œ</option>
            <option value="country" selected>êµ­ê°€</option>
            <option value="city">ë„ì‹œ</option>
            <option value="neighborhood">ë™ë„¤</option>
            <option value="friends">ì¹œêµ¬</option>
          </select>
          <select class="select" id="typeSel">
            <option value="skill">ì‹¤ë ¥ ì ìˆ˜</option>
            <option value="business">ìš´ì˜ ì ìˆ˜</option>
          </select>
        </div>
        <div class="tabs" id="periodTabs">
          <button class="tab active">ì¼ê°„</button>
          <button class="tab">ì£¼ê°„</button>
          <button class="tab">ì›”ê°„</button>
          <button class="tab">ì‹œì¦Œ</button>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>#</th><th>ë‹‰ë„¤ì„</th><th>ì ìˆ˜</th><th>ì§€ì—­</th></tr></thead>
            <tbody id="rankBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <div class="bottom">
      <button class="nav active" data-screen="home">í™ˆ</button>
      <button class="nav" data-screen="shop">ìƒì </button>
      <button class="nav" data-screen="rank">ë­í‚¹</button>
    </div>
  </div>

  <canvas id="fxCanvas"></canvas>
  <button class="audio-fab show" id="audioFab">ğŸ”Š ì‚¬ìš´ë“œ ì‹œì‘</button>

  <div class="modal" id="offlineModal">
    <div class="box">
      <div class="title">ì˜¤í”„ë¼ì¸ 2ë°° ìˆ˜ë ¹</div>
      <div class="sub" style="margin-top:6px">ìºì‹œ 29 ì‚¬ìš© ì‹œ ì´ë²ˆ ì˜¤í”„ë¼ì¸ ë³´ìƒì„ 2ë°°ë¡œ ë°›ìŠµë‹ˆë‹¤.</div>
      <div class="actions">
        <button class="btn" id="offCancel">ì·¨ì†Œ</button>
        <button class="btn cyan" id="offConfirm">ê²°ì œ</button>
      </div>
    </div>
  </div>

  <div class="sheet" id="buySheet">
    <div class="panel">
      <div class="title" id="buyName">ìƒí’ˆëª…</div>
      <div class="sub" id="buyDesc" style="margin-top:4px"></div>
      <div class="line"><span>ê°€ê²©</span><b id="buyPrice">â‚©0</b></div>
      <div class="line"><span>ì§€ê¸‰</span><b>ì¦‰ì‹œ ì§€ê¸‰</b></div>
      <div class="actions" style="margin-top:12px">
        <button class="btn" id="buyCancel">ì·¨ì†Œ</button>
        <button class="btn primary" id="buyConfirm">ê²°ì œí•˜ê¸°</button>
      </div>
    </div>
  </div>

<script>
(async () => {
  const tabs = [
    { key: 'recommended', label: 'ì¶”ì²œ' },
    { key: 'convenience', label: 'í¸ì˜' },
    { key: 'growth', label: 'ì„±ì¥' },
    { key: 'skins', label: 'ìŠ¤í‚¨' },
    { key: 'pass', label: 'íŒ¨ìŠ¤' },
    { key: 'vip', label: 'VIP' }
  ];

  const state = {
    currentScreen: 'home',
    shopTab: 'recommended',
    catalog: null,
    ranking: null,
    selectedSku: null,
    apiBase: new URLSearchParams(location.search).get('api') || '',
    apiOnline: false,
    audioReady: false,
    audioOn: true,
    audioCtx: null,
    masterGain: null,
    masterComp: null,
    bgmTimer: null,
    particles: [],
    lastSfxAt: 0
  };

  const $ = (q) => document.querySelector(q);
  const $$ = (q) => [...document.querySelectorAll(q)];

  function setApiStatus(text, tone = 'INIT') {
    const el = $('#apiStatus b');
    if (!el) return;
    el.textContent = text;
    const map = {
      INIT: '#475569',
      ONLINE: '#16a34a',
      MOCK: '#db2777',
      ERROR: '#dc2626'
    };
    el.style.color = map[tone] || '#475569';
  }

  async function apiFetch(path, options = {}) {
    if (!state.apiBase) throw new Error('NO_API_BASE');
    const url = `${state.apiBase.replace(/\/$/, '')}${path}`;
    const res = await fetch(url, options);
    if (!res.ok) throw new Error(`API_${res.status}`);
    return res.json();
  }

  document.addEventListener('pointerdown', (e) => {
    const t = e.target.closest('button,.tab,.buy,.nav,.select');
    enableAudio();
    if (t && state.audioOn) clickSfx();
  }, { passive: true });

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) stopCuteBgm();
    else if (state.audioOn) {
      unlockAudio();
      startCuteBgm();
    }
  });

  const fxCanvas = $('#fxCanvas');
  const fx = fxCanvas.getContext('2d');

  function resizeFx(){
    fxCanvas.width = innerWidth;
    fxCanvas.height = innerHeight;
  }
  resizeFx();
  addEventListener('resize', resizeFx);

  function burst(x, y, color = '#f472b6') {
    for (let i = 0; i < 24; i++) {
      const a = (Math.PI * 2 * i) / 24 + Math.random() * 0.4;
      const sp = 1.5 + Math.random() * 3.6;
      state.particles.push({
        x, y,
        vx: Math.cos(a) * sp,
        vy: Math.sin(a) * sp - 1.4,
        life: 34 + Math.random() * 20,
        size: 2 + Math.random() * 3,
        color
      });
    }
  }

  function tickFx(){
    fx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
    for (let i = state.particles.length - 1; i >= 0; i--) {
      const p = state.particles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.08;
      p.life -= 1;
      if (p.life <= 0) { state.particles.splice(i, 1); continue; }

      fx.globalAlpha = Math.max(0, p.life / 50);
      fx.fillStyle = p.color;
      fx.beginPath();
      fx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      fx.fill();
    }
    fx.globalAlpha = 1;
    requestAnimationFrame(tickFx);
  }
  requestAnimationFrame(tickFx);

  function ensureAudio(){
    if (state.audioReady) return true;
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return false;
    state.audioCtx = new AC();

    state.masterGain = state.audioCtx.createGain();
    state.masterGain.gain.value = 1.8; // louder default

    state.masterComp = state.audioCtx.createDynamicsCompressor();
    state.masterComp.threshold.value = -18;
    state.masterComp.knee.value = 20;
    state.masterComp.ratio.value = 10;
    state.masterComp.attack.value = 0.003;
    state.masterComp.release.value = 0.2;

    state.masterGain.connect(state.masterComp).connect(state.audioCtx.destination);
    state.audioReady = true;
    return true;
  }

  function unlockAudio(){
    if (!ensureAudio()) return false;
    if (state.audioCtx && state.audioCtx.state === 'suspended') {
      state.audioCtx.resume();
    }
    $('#audioFab')?.classList.remove('show');
    if (state.audioOn) startCuteBgm();
    return true;
  }

  function enableAudio(){
    const ok = unlockAudio();
    if (ok && state.audioOn) {
      // boot chirp so user immediately hears audio is active
      tone(1046.5, 0.12, 'sine', 0.28);
      clickSfx();
      startCuteBgm();
    }
  }

  function tone(freq, dur = 0.08, type = 'triangle', vol = 0.2, at = null) {
    if (!state.audioOn || !state.audioCtx || !state.masterGain) return;
    const ctx = state.audioCtx;
    const t0 = at ?? ctx.currentTime;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(vol, t0 + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    osc.connect(gain).connect(state.masterGain);
    osc.start(t0);
    osc.stop(t0 + dur + 0.02);
  }

  function playClick(){
    tone(980, 0.095, 'triangle', 0.24);
  }

  function clickSfx(){
    const now = performance.now();
    if (now - state.lastSfxAt < 90) return;
    state.lastSfxAt = now;
    playClick();
  }

  function playHit(){
    const t = state.audioCtx?.currentTime || 0;
    tone(380, 0.11, 'square', 0.28, t);
    tone(620, 0.14, 'triangle', 0.24, t + 0.02);
    tone(920, 0.16, 'sine', 0.2, t + 0.04);
  }

  const melody = [523.25, 659.25, 783.99, 659.25, 587.33, 698.46, 783.99, 880.0];
  const bass = [130.81, 146.83, 164.81, 196.0];
  function startCuteBgm(){
    if (!state.audioOn || !state.audioCtx || state.bgmTimer) return;
    const ctx = state.audioCtx;
    let idx = 0;
    let b = 0;
    const schedule = () => {
      const t = ctx.currentTime + 0.04;
      for (let i = 0; i < 8; i++) {
        const f = melody[(idx + i) % melody.length];
        tone(f, 0.2, 'sine', 0.15, t + i * 0.2);
      }
      tone(bass[b % bass.length], 0.35, 'triangle', 0.12, t + 0.02);
      tone(bass[(b + 1) % bass.length], 0.35, 'triangle', 0.12, t + 0.82);
      idx = (idx + 2) % melody.length;
      b = (b + 1) % bass.length;
    };
    schedule();
    state.bgmTimer = setInterval(schedule, 1600);
  }

  function stopCuteBgm(){
    if (state.bgmTimer) {
      clearInterval(state.bgmTimer);
      state.bgmTimer = null;
    }
  }

  function toast(msg){
    const el = document.createElement('div');
    el.textContent = msg;
    Object.assign(el.style,{position:'fixed',left:'50%',top:'72px',transform:'translateX(-50%)',background:'#fff',color:'#db2777',border:'1px solid #f9a8d4',padding:'8px 11px',borderRadius:'999px',fontWeight:'800',zIndex:50,boxShadow:'0 8px 18px rgba(236,72,153,.2)'});
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),900);
  }

  function centerOf(el){
    const r = el.getBoundingClientRect();
    return { x: r.left + r.width / 2, y: r.top + r.height / 2 };
  }

  async function loadData(){
    try {
      if (state.apiBase) {
        const [health, c, rs, rb] = await Promise.all([
          apiFetch('/health'),
          apiFetch('/api/shop/catalog?uid=6702395893&country=KR&city=Seoul&segment=default'),
          apiFetch('/api/rankings?scope=country&period=weekly&type=skill'),
          apiFetch('/api/rankings?scope=country&period=weekly&type=business')
        ]);

        state.apiOnline = !!health?.ok;
        state.catalog = c.tabs;
        state.ranking = {
          skill: { country: rs.rows || [] },
          business: { country: rb.rows || [] }
        };
        setApiStatus('ONLINE', 'ONLINE');
        return;
      }
      throw new Error('NO_API');
    } catch {
      const [c,r] = await Promise.all([
        fetch('./mock/catalog.json').then(v=>v.json()),
        fetch('./mock/ranking.json').then(v=>v.json())
      ]);
      state.catalog = c;
      state.ranking = r;
      setApiStatus('MOCK', 'MOCK');
    }
  }

  function setScreen(name){
    state.currentScreen = name;
    $$('.screen').forEach(s=>s.classList.remove('active'));
    $(`#screen-${name}`).classList.add('active');
    $$('.nav').forEach(n=>n.classList.toggle('active', n.dataset.screen === name));
    if(name==='shop') renderShop();
    if(name==='rank') renderRank();
  }

  function renderShopTabs(){
    const box = $('#shopTabs');
    box.innerHTML = tabs.map(t=>`<button class="tab ${state.shopTab===t.key?'active':''}" data-tab="${t.key}">${t.label}</button>`).join('');
    box.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{
      clickSfx();
      const c = centerOf(b); burst(c.x, c.y, '#f472b6');
      state.shopTab=b.dataset.tab;
      renderShop();
    });
  }

  function tagClass(tag=''){ return tag.toLowerCase()==='hot'?'hot':tag.toLowerCase()==='best'?'best':''; }

  function renderShop(){
    renderShopTabs();
    const list = state.catalog?.[state.shopTab] || [];
    $('#shopList').innerHTML = list.map(i=>`
      <div class="sku">
        <div>
          <div style="display:flex;gap:6px;align-items:center"><span class="name">${i.name}</span>${i.tag?`<span class="tag ${tagClass(i.tag)}">${i.tag}</span>`:''}</div>
          <div class="sub" style="margin-top:4px">${i.desc}</div>
        </div>
        <button class="buy" data-id="${i.id}">${i.price}</button>
      </div>
    `).join('');

    $('#shopList').querySelectorAll('.buy').forEach(btn=>{
      btn.onclick = () => {
        clickSfx();
        const c = centerOf(btn); burst(c.x, c.y, '#22d3ee');
        state.selectedSku = list.find(x=>x.id===btn.dataset.id);
        $('#buyName').textContent = state.selectedSku.name;
        $('#buyDesc').textContent = state.selectedSku.desc;
        $('#buyPrice').textContent = state.selectedSku.price;
        $('#buySheet').classList.add('show');
      };
    });
  }

  function pickRankRowsFallback(){
    const scope = $('#scopeSel').value;
    const type = $('#typeSel').value;
    const src = state.ranking?.[type] || {};
    return src[scope] || src.country || [];
  }

  async function renderRank(){
    let rows = [];
    const scope = $('#scopeSel').value;
    const type = $('#typeSel').value;

    try {
      if (state.apiBase) {
        const r = await apiFetch(`/api/rankings?scope=${scope}&period=weekly&type=${type}`);
        rows = r.rows || [];
      } else {
        rows = pickRankRowsFallback();
      }
    } catch {
      rows = pickRankRowsFallback();
      if (state.apiBase) setApiStatus('ERROR', 'ERROR');
    }

    $('#rankBody').innerHTML = rows.map(r=>`<tr><td>${r.rank}</td><td>${r.name}</td><td>${Number(r.score).toLocaleString()}</td><td>${r.region}</td></tr>`).join('');
  }

  // events
  $$('.nav').forEach(n=>n.onclick=()=>{
    unlockAudio();
    clickSfx();
    const c = centerOf(n); burst(c.x, c.y, '#f472b6');
    setScreen(n.dataset.screen);
  });

  $('#quickShop').onclick = (e) => {
    unlockAudio();
    clickSfx();
    const c = centerOf(e.currentTarget); burst(c.x, c.y, '#22d3ee');
    setScreen('shop');
  };

  $('#audioFab').onclick = (e) => {
    enableAudio();
    const c = centerOf(e.currentTarget); burst(c.x, c.y, '#22d3ee');
    toast('ì‚¬ìš´ë“œ í™œì„±í™” ì™„ë£Œ ğŸµ');
  };

  $('#soundToggle').onclick = (e) => {
    ensureAudio();
    unlockAudio();
    state.audioOn = !state.audioOn;
    e.currentTarget.textContent = state.audioOn ? 'ğŸ”Š' : 'ğŸ”ˆ';
    const c = centerOf(e.currentTarget); burst(c.x, c.y, state.audioOn ? '#22d3ee' : '#f472b6');
    if (state.audioOn) {
      startCuteBgm();
      clickSfx();
      toast('ì‚¬ìš´ë“œ ON ğŸµ');
    } else {
      stopCuteBgm();
      toast('ì‚¬ìš´ë“œ OFF');
    }
  };

  $('#btnOffline2x').onclick = (e) => {
    unlockAudio();
    clickSfx();
    const c = centerOf(e.currentTarget); burst(c.x, c.y, '#22d3ee');
    $('#offlineModal').classList.add('show');
  };

  $('#offCancel').onclick = (e) => {
    unlockAudio();
    clickSfx();
    const c = centerOf(e.currentTarget); burst(c.x, c.y, '#f9a8d4');
    $('#offlineModal').classList.remove('show');
  };

  $('#offConfirm').onclick = async (e) => {
    unlockAudio();
    playHit();
    const c = centerOf(e.currentTarget); burst(c.x, c.y, '#22c55e');
    $('#offlineModal').classList.remove('show');

    try {
      if (state.apiBase) {
        const r = await apiFetch('/api/economy/offline/claim', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: '6702395893', claimType: 'x2' })
        });
        toast(`2ë°° ìˆ˜ë ¹ ì™„ë£Œ +${Number(r.rewards.gold).toLocaleString()}G`);
      } else {
        toast('ì˜¤í”„ë¼ì¸ 2ë°° ìˆ˜ë ¹ ê²°ì œ ì™„ë£Œ');
      }
    } catch {
      toast('ìˆ˜ë ¹ ì²˜ë¦¬ ì‹¤íŒ¨ (ì¬ì‹œë„)');
      setApiStatus('ERROR', 'ERROR');
    }
  };

  $('#buyCancel').onclick = (e) => {
    unlockAudio();
    clickSfx();
    const c = centerOf(e.currentTarget); burst(c.x, c.y, '#f9a8d4');
    $('#buySheet').classList.remove('show');
  };

  $('#buyConfirm').onclick = async (e) => {
    unlockAudio();
    playHit();
    const c = centerOf(e.currentTarget);
    burst(c.x, c.y, '#22c55e');
    burst(c.x + 24, c.y - 12, '#f472b6');
    const name = state.selectedSku?.name || 'ìƒí’ˆ';
    const skuId = state.selectedSku?.id;
    $('#buySheet').classList.remove('show');

    try {
      if (state.apiBase && skuId) {
        const r = await apiFetch('/api/shop/purchase/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uid: '6702395893',
            skuId,
            platform: 'web',
            receipt: 'mock-receipt',
            txId: `tx_${Date.now()}`
          })
        });
        toast(`${name} ê²°ì œ ì™„ë£Œ (+${r.walletDelta.freeCash || 0} ìºì‹œ)`);
      } else {
        toast(`${name} ê²°ì œ ì™„ë£Œ`);
      }
    } catch {
      toast('ê²°ì œ ê²€ì¦ ì‹¤íŒ¨ (ì¬ì‹œë„)');
      setApiStatus('ERROR', 'ERROR');
    }
  };

  $('#scopeSel').onchange = (e) => { unlockAudio(); clickSfx(); const c=centerOf(e.currentTarget); burst(c.x,c.y,'#f472b6'); renderRank(); };
  $('#typeSel').onchange = (e) => { unlockAudio(); clickSfx(); const c=centerOf(e.currentTarget); burst(c.x,c.y,'#22d3ee'); renderRank(); };

  // bootstrap
  try {
    await loadData();
    renderShop();
    renderRank();
  } catch (e) {
    console.error(e);
    toast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
  }
})();
</script>
</body>
</html>
