<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>í¬ì°¨íŒ¡ - Playable v2</title>
  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#eefdff;
      --card:#ffffffee;
      --line:#f9a8d4;
      --text:#334155;
      --muted:#64748b;
      --pink:#ec4899;
      --cyan:#22d3ee;
      --green:#22c55e;
      --orange:#fb923c;
      --danger:#f43f5e;
      --shadow:0 10px 24px rgba(236,72,153,.13);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 500px at 10% -10%, #fbcfe8aa, transparent 45%),
        radial-gradient(900px 600px at 110% 20%, #bae6fdaa, transparent 40%),
        linear-gradient(180deg,var(--bg2),var(--bg1));
    }
    .phone{
      width:min(440px,100vw);
      margin:0 auto;
      min-height:100vh;
      border-left:1px solid #fbcfe8;
      border-right:1px solid #fbcfe8;
      background:linear-gradient(180deg,rgba(255,255,255,.94),rgba(255,255,255,.72));
      box-shadow:0 16px 40px rgba(15,23,42,.12);
      display:grid;
      grid-template-rows:auto auto auto 1fr auto auto;
      gap:8px;
      padding:10px;
      position:relative;
      overflow:hidden;
    }
    .card{
      background:var(--card);
      border:1px solid #fbcfe8;
      border-radius:16px;
      padding:10px;
      box-shadow:var(--shadow);
    }
    .row{display:flex;gap:8px;align-items:center}
    .between{justify-content:space-between}

    .title{font-weight:900;letter-spacing:.01em;color:#be185d}
    .muted{font-size:12px;color:var(--muted)}

    .chip{
      border:1px solid #fbcfe8;
      background:#fff;
      border-radius:999px;
      padding:4px 8px;
      font-size:12px;
      font-weight:800;
      color:#475569;
    }
    .chip b{color:#0f172a}

    .topbar .sound{
      border:1px solid #22d3ee;
      background:linear-gradient(180deg,#a5f3fc,#67e8f9);
      color:#0e7490;
      border-radius:11px;
      padding:7px 10px;
      font-weight:900;
      min-width:42px;
    }

    .hud-grid{
      display:grid;
      grid-template-columns:repeat(5,minmax(0,1fr));
      gap:8px;
    }
    .stat .k{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .stat .v{font-size:17px;font-weight:900;margin-top:2px}
    .stat.fever .v{color:#ea580c}

    .scene{
      border:1px solid #fbcfe8;
      border-radius:16px;
      padding:10px;
      background:
        linear-gradient(180deg,#fdf2f8 0%, #ecfeff 65%, #f8fafc 100%);
      position:relative;
      overflow:hidden;
    }
    .scene:before{
      content:'';
      position:absolute;
      left:-20%; right:-20%; bottom:30%;
      height:120px;
      background:radial-gradient(60% 120% at 50% 100%, #f9a8d466, transparent 70%);
      pointer-events:none;
    }

    .order-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .customers{
      display:grid;
      grid-auto-flow:column;
      grid-auto-columns:120px;
      gap:8px;
      overflow-x:auto;
      padding-bottom:2px;
      min-height:108px;
    }
    .cust{
      border:1px solid #fbcfe8;
      border-radius:14px;
      background:#fff;
      padding:8px;
      display:grid;
      align-content:space-between;
      box-shadow:0 4px 12px rgba(236,72,153,.09);
    }
    .avatar{font-size:24px;line-height:1}
    .bubble{font-size:13px;font-weight:900;color:#0f172a}
    .reward{font-size:11px;color:#475569}
    .bar{height:7px;border-radius:999px;background:#fce7f3;border:1px solid #fbcfe8;overflow:hidden}
    .bar i{display:block;height:100%;width:100%;transform-origin:left center;background:linear-gradient(90deg,#22c55e,#facc15,#f43f5e)}

    .kitchen-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px}
    .station{
      border:1px solid #fbcfe8;
      border-radius:14px;
      background:#fff;
      padding:8px;
      display:grid;
      gap:6px;
    }
    .station .h{font-size:14px;font-weight:900;color:#0f172a}
    .station .m{font-size:11px;color:#64748b}
    .meter{height:8px;border-radius:999px;background:#fce7f3;border:1px solid #fbcfe8;overflow:hidden}
    .meter i{display:block;height:100%;width:100%;transform-origin:left center;background:linear-gradient(90deg,#22d3ee,#ec4899)}
    .cook-btn{
      border:1px solid #22d3ee;
      background:linear-gradient(180deg,#a5f3fc,#67e8f9);
      color:#0e7490;
      border-radius:10px;
      padding:8px;
      font-weight:900;
    }
    .cook-btn:disabled{opacity:.5}

    .tray-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .tray-btn{
      border:1px solid #86efac;
      background:linear-gradient(180deg,#dcfce7,#bbf7d0);
      color:#166534;
      border-radius:11px;
      padding:8px;
      font-weight:900;
    }
    .tray-btn:disabled{opacity:.5}

    .controls{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .btn{
      border:1px solid #f9a8d4;
      background:#fff;
      color:#334155;
      border-radius:12px;
      padding:10px 8px;
      font-weight:900;
    }
    .btn.primary{background:linear-gradient(180deg,#f9a8d4,#f472b6);border-color:#f472b6;color:#fff}
    .btn.cyan{background:linear-gradient(180deg,#a5f3fc,#67e8f9);border-color:#22d3ee;color:#0e7490}

    .status{font-size:12px;color:#475569}

    .toast{
      position:fixed;
      left:50%; top:72px;
      transform:translateX(-50%);
      background:#fff;
      border:1px solid #f9a8d4;
      border-radius:999px;
      padding:7px 12px;
      color:#db2777;
      font-weight:900;
      opacity:0;
      transition:opacity .22s ease;
      pointer-events:none;
      z-index:70;
      box-shadow:0 8px 18px rgba(236,72,153,.2);
    }
    .toast.show{opacity:1}

    .float{
      position:absolute;
      z-index:60;
      font-weight:900;
      pointer-events:none;
      animation:up .92s ease forwards;
      text-shadow:0 2px 8px rgba(0,0,0,.18);
    }
    .float.good{color:#16a34a}
    .float.bad{color:#e11d48}
    @keyframes up{from{transform:translateY(0);opacity:1}to{transform:translateY(-34px);opacity:0}}

    .overlay{
      position:absolute;
      inset:0;
      background:rgba(15,23,42,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:65;
      padding:12px;
    }
    .overlay.show{display:flex}
    .panel{
      width:min(360px,92vw);
      background:#fff;
      border:1px solid #f9a8d4;
      border-radius:16px;
      padding:14px;
      box-shadow:0 16px 40px rgba(15,23,42,.2);
    }

    #fx{position:fixed;inset:0;pointer-events:none;z-index:68}

    .pulse{animation:pulse 1.4s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,211,238,.45)}70%{box-shadow:0 0 0 14px rgba(34,211,238,0)}100%{box-shadow:0 0 0 0 rgba(34,211,238,0)}}

    @media (max-width:460px){
      .hud-grid{grid-template-columns:repeat(3,minmax(0,1fr));}
      .controls{grid-template-columns:1fr 1fr;}
      .customers{grid-auto-columns:112px}
    }
  </style>
</head>
<body>
  <div class="phone" id="app">
    <div class="card topbar row between">
      <div class="title">ğŸ¡ í¬ì°¨íŒ¡ - í”Œë ˆì´ v2</div>
      <div class="row" style="justify-content:flex-end">
        <button class="sound" id="soundBtn">ğŸ”Š</button>
      </div>
    </div>

    <div class="row" style="flex-wrap:wrap">
      <span class="chip">ê³¨ë“œ <b id="walletGold">0</b></span>
      <span class="chip">ë¬´ë£Œìºì‹œ <b id="walletFree">0</b></span>
      <span class="chip">ìœ ë£Œìºì‹œ <b id="walletPaid">0</b></span>
      <span class="chip">baseRPM <b id="baseRpm">0</b></span>
    </div>

    <div class="hud-grid">
      <div class="card stat"><div class="k">Time</div><div class="v" id="timeLeft">120</div></div>
      <div class="card stat"><div class="k">Run Gold</div><div class="v" id="runGold">0</div></div>
      <div class="card stat"><div class="k">Combo</div><div class="v" id="combo">x0</div></div>
      <div class="card stat"><div class="k">Life</div><div class="v" id="life">â¤ï¸â¤ï¸â¤ï¸</div></div>
      <div class="card stat fever"><div class="k">Fever</div><div class="v" id="fever">OFF</div></div>
    </div>

    <div class="scene card" id="scene">
      <div class="order-head">
        <div class="title" style="color:#0f172a">ì†ë‹˜ ì£¼ë¬¸</div>
        <div class="muted">ì‹œê°„ ë‚´ ì„œë¹™!</div>
      </div>
      <div class="customers" id="customers"></div>
    </div>

    <div class="card">
      <div class="row between">
        <div class="title" style="color:#0f172a">ì¡°ë¦¬ ìŠ¤í…Œì´ì…˜</div>
        <div class="muted">í•œ ì¹¸ë‹¹ 1ê°œ ì¡°ë¦¬</div>
      </div>
      <div class="kitchen-grid" id="stations"></div>
    </div>

    <div class="card">
      <div class="row between">
        <div class="title" style="color:#0f172a">íŠ¸ë ˆì´ ì¬ê³ </div>
        <div class="muted">ëˆŒëŸ¬ì„œ ì¦‰ì‹œ ì„œë¹™</div>
      </div>
      <div class="tray-grid" id="tray"></div>
    </div>

    <div class="controls">
      <button class="btn cyan" id="pauseBtn">ì¼ì‹œì •ì§€</button>
      <button class="btn" id="startBtn">ê²Œì„ ì‹œì‘</button>
      <button class="btn primary pulse" id="restartBtn">ì¬ì‹œì‘</button>
    </div>

    <div class="card status" id="status">ì¤€ë¹„ ì™„ë£Œ. ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</div>

    <div class="overlay" id="overlay">
      <div class="panel">
        <div class="title" id="ovTitle">ë¼ìš´ë“œ ì¢…ë£Œ</div>
        <div class="muted" id="ovDesc" style="margin-top:8px"></div>
        <div class="row" style="justify-content:flex-end;margin-top:12px">
          <button class="btn primary" id="ovBtn">í™•ì¸</button>
        </div>
      </div>
    </div>
  </div>

  <canvas id="fx"></canvas>
  <div class="toast" id="toast"></div>

<script>
(() => {
  const RECIPES = {
    fish:    { name: 'ë¶•ì–´ë¹µ', emoji: 'ğŸŸ', cookMs: 2200, reward: 180 },
    hotteok: { name: 'í˜¸ë–¡',   emoji: 'ğŸ¥', cookMs: 2800, reward: 230 },
    odeng:   { name: 'ì–´ë¬µ',   emoji: 'ğŸ¢', cookMs: 1700, reward: 140 },
    tteok:   { name: 'ë–¡ë³¶ì´', emoji: 'ğŸœ', cookMs: 3300, reward: 280 }
  };
  const KEYS = Object.keys(RECIPES);
  const AVATARS = ['ğŸ˜º','ğŸ»','ğŸ¦Š','ğŸ¼','ğŸµ','ğŸ°','ğŸ¦','ğŸ¶'];
  const WALLET_KEY = 'ppocha_wallet_v2';

  const $ = (q) => document.querySelector(q);
  const app = $('#app');
  const customersEl = $('#customers');
  const stationsEl = $('#stations');
  const trayEl = $('#tray');

  const fxCanvas = $('#fx');
  const fx = fxCanvas.getContext('2d');
  function resizeFx(){ fxCanvas.width = innerWidth; fxCanvas.height = innerHeight; }
  resizeFx(); addEventListener('resize', resizeFx);

  const state = {
    wallet: null,
    running: false,
    paused: false,
    ended: false,
    leftMs: 120000,
    totalMs: 120000,
    lives: 3,
    combo: 0,
    runGold: 0,
    feverUntil: 0,
    served: 0,
    missed: 0,
    orders: [],
    orderSeq: 1,
    spawnCd: 1200,
    stations: {
      fish: { busy: false, left: 0, total: 0 },
      hotteok: { busy: false, left: 0, total: 0 },
      odeng: { busy: false, left: 0, total: 0 },
      tteok: { busy: false, left: 0, total: 0 }
    },
    tray: { fish:0, hotteok:0, odeng:0, tteok:0 },
    lastTs: 0,
    particles: [],
    audioCtx: null,
    audioOn: true,
    bgmTimer: null,
    masterGain: null
  };

  function now(){ return Date.now(); }

  function defaultWallet(){
    return { gold:128550, freeCash:480, paidCash:120, baseRPM:185, lastSeenAtMs: now() - 3 * 3600 * 1000 };
  }
  function loadWallet(){
    try {
      const v = JSON.parse(localStorage.getItem(WALLET_KEY) || 'null');
      return v && typeof v === 'object' ? { ...defaultWallet(), ...v } : defaultWallet();
    } catch { return defaultWallet(); }
  }
  function saveWallet(){ localStorage.setItem(WALLET_KEY, JSON.stringify(state.wallet)); }

  function toast(msg){
    const el = $('#toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(toast.t);
    toast.t = setTimeout(() => el.classList.remove('show'), 900);
  }

  function floatText(text, x, y, bad = false){
    const el = document.createElement('div');
    el.className = `float ${bad ? 'bad' : 'good'}`;
    el.textContent = text;
    el.style.left = `${x}px`;
    el.style.top = `${y}px`;
    app.appendChild(el);
    setTimeout(() => el.remove(), 920);
  }

  function burst(x, y, color = '#f472b6'){
    for (let i = 0; i < 24; i++) {
      const a = (Math.PI * 2 * i / 24) + Math.random() * 0.4;
      const s = 1.6 + Math.random() * 3.6;
      state.particles.push({ x, y, vx: Math.cos(a) * s, vy: Math.sin(a) * s - 1, life: 26 + Math.random() * 18, size: 2 + Math.random() * 3, color });
    }
  }

  function fxLoop(){
    fx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    for (let i = state.particles.length - 1; i >= 0; i--) {
      const p = state.particles[i];
      p.x += p.vx; p.y += p.vy; p.vy += .07; p.life -= 1;
      if (p.life <= 0) { state.particles.splice(i,1); continue; }
      fx.globalAlpha = Math.max(0, p.life / 42);
      fx.fillStyle = p.color;
      fx.beginPath(); fx.arc(p.x, p.y, p.size, 0, Math.PI * 2); fx.fill();
    }
    fx.globalAlpha = 1;
    requestAnimationFrame(fxLoop);
  }
  requestAnimationFrame(fxLoop);

  function updateHUD(){
    $('#walletGold').textContent = state.wallet.gold.toLocaleString();
    $('#walletFree').textContent = state.wallet.freeCash.toLocaleString();
    $('#walletPaid').textContent = state.wallet.paidCash.toLocaleString();
    $('#baseRpm').textContent = state.wallet.baseRPM;

    $('#timeLeft').textContent = Math.max(0, Math.ceil(state.leftMs / 1000));
    $('#runGold').textContent = state.runGold.toLocaleString();
    $('#combo').textContent = `x${state.combo}`;
    $('#life').textContent = 'â¤ï¸'.repeat(Math.max(0, state.lives));
    const feverOn = state.feverUntil > now();
    $('#fever').textContent = feverOn ? `ON ${Math.ceil((state.feverUntil - now())/1000)}s` : 'OFF';
  }

  function renderCustomers(){
    customersEl.innerHTML = '';
    for (const o of state.orders) {
      const div = document.createElement('div');
      div.className = 'cust';
      const ratio = Math.max(0, o.left / o.max);
      div.innerHTML = `
        <div class="row between">
          <div class="avatar">${o.avatar}</div>
          <div class="reward">+${o.reward}G</div>
        </div>
        <div class="bubble">${RECIPES[o.key].emoji} ${RECIPES[o.key].name}</div>
        <div class="bar"><i style="transform:scaleX(${ratio})"></i></div>
      `;
      customersEl.appendChild(div);
    }
  }

  function renderStations(){
    stationsEl.innerHTML = '';
    for (const key of KEYS) {
      const r = RECIPES[key];
      const st = state.stations[key];
      const p = st.total > 0 ? 1 - st.left / st.total : 0;
      const div = document.createElement('div');
      div.className = 'station';
      div.innerHTML = `
        <div class="h">${r.emoji} ${r.name}</div>
        <div class="m">${(r.cookMs/1000).toFixed(1)}ì´ˆ Â· +${r.reward}G</div>
        <div class="meter"><i style="transform:scaleX(${Math.max(0, Math.min(1, p))})"></i></div>
      `;
      const btn = document.createElement('button');
      btn.className = 'cook-btn';
      btn.textContent = st.busy ? `ì¡°ë¦¬ì¤‘ ${(st.left/1000).toFixed(1)}s` : 'ì¡°ë¦¬ ì‹œì‘';
      btn.disabled = st.busy || !state.running || state.paused || state.ended;
      btn.onclick = () => startCook(key, btn);
      div.appendChild(btn);
      stationsEl.appendChild(div);
    }
  }

  function renderTray(){
    trayEl.innerHTML = '';
    for (const key of KEYS) {
      const r = RECIPES[key];
      const c = state.tray[key] || 0;
      const b = document.createElement('button');
      b.className = 'tray-btn';
      b.disabled = c <= 0 || !state.running || state.paused || state.ended;
      b.textContent = `${r.emoji} ${r.name} Â· ${c}`;
      b.onclick = () => serveFromTray(key, b);
      trayEl.appendChild(b);
    }
  }

  function randKey(){ return KEYS[(Math.random() * KEYS.length) | 0]; }

  function spawnOrder(){
    if (state.orders.length >= 7) return;
    const key = randKey();
    const max = 6500 + Math.random() * 4000;
    const reward = RECIPES[key].reward + ((Math.random() * 45) | 0);
    state.orders.push({ id: state.orderSeq++, key, max, left:max, reward, avatar: AVATARS[(Math.random() * AVATARS.length) | 0] });
  }

  function startCook(key, btn){
    const st = state.stations[key];
    if (st.busy || !state.running || state.paused || state.ended) return;
    const base = RECIPES[key].cookMs;
    const feverOn = state.feverUntil > now();
    const total = feverOn ? Math.floor(base * 0.82) : base;
    st.busy = true; st.total = total; st.left = total;
    status(`${RECIPES[key].name} ì¡°ë¦¬ ì‹œì‘`);
    playSfx('start');
    pop(btn, '#22d3ee');
    renderStations();
  }

  function completeCook(key){
    const st = state.stations[key];
    st.busy = false; st.left = 0; st.total = 0;

    const idx = state.orders.findIndex(o => o.key === key);
    if (idx >= 0) {
      serveOrder(idx, key, true);
    } else {
      state.tray[key] += 1;
      toast(`${RECIPES[key].name} ì™„ì„±! (íŠ¸ë ˆì´ ì ì¬)`);
      playSfx('done');
      renderTray();
    }
    renderStations();
  }

  function serveOrder(index, key, auto = false){
    const order = state.orders[index];
    state.orders.splice(index, 1);

    state.combo += 1;
    if (state.combo >= 5 && state.feverUntil < now()) {
      state.feverUntil = now() + 12000;
      toast('ğŸ”¥ FEVER ON!');
    }

    const comboMul = 1 + Math.min(0.45, state.combo * 0.03);
    const feverMul = state.feverUntil > now() ? 1.5 : 1;
    const gain = Math.floor(order.reward * comboMul * feverMul);
    state.runGold += gain;
    state.served += 1;

    playSfx('serve');
    const rc = app.getBoundingClientRect();
    floatText(`+${gain}G`, rc.width * 0.5, 180);
    if (auto) toast(`${RECIPES[key].name} ì¦‰ì‹œ ì„œë¹™!`);

    renderCustomers();
    updateHUD();
    status(`${RECIPES[key].name} ì„œë¹™ ì„±ê³µ (ì½¤ë³´ x${state.combo})`);
  }

  function serveFromTray(key, btn){
    if (state.tray[key] <= 0) return;
    const idx = state.orders.findIndex(o => o.key === key);
    if (idx < 0) {
      toast('í•´ë‹¹ ì£¼ë¬¸ ì—†ìŒ');
      playSfx('miss');
      pop(btn, '#f43f5e');
      return;
    }
    state.tray[key] -= 1;
    serveOrder(idx, key, false);
    renderTray();
    pop(btn, '#22c55e');
  }

  function missOrder(){
    state.lives -= 1;
    state.combo = 0;
    state.feverUntil = 0;
    playSfx('miss');
    const rc = app.getBoundingClientRect();
    floatText('ì£¼ë¬¸ ì‹¤íŒ¨!', rc.width * 0.48, 200, true);
    toast('ì£¼ë¬¸ ì‹¤íŒ¨ - ìƒëª… ê°ì†Œ');
    if (state.lives <= 0) endGame('ì†ë‹˜ ë¶ˆë§Œ í­ì£¼!');
  }

  function decay(min){ if(min <= 120) return 1; if(min <= 480) return .6; return .25; }

  function tryOfflineReward(){
    const n = now();
    const min = Math.min(1440, Math.max(0, Math.floor((n - state.wallet.lastSeenAtMs) / 60000)));
    if (min < 5) return;
    const d = decay(min);
    const g = Math.floor(state.wallet.baseRPM * min * d);
    const f = Math.min(40, Math.floor(min / 30));

    $('#ovTitle').textContent = 'ì˜¤í”„ë¼ì¸ ìˆ˜ìµ ë„ì°©';
    $('#ovDesc').innerHTML = `ë¯¸ì ‘ì† ${min}ë¶„ / ê°ì‡  ${d}<br>ê³¨ë“œ +${g.toLocaleString()} / ë¬´ë£Œìºì‹œ +${f}`;
    $('#overlay').classList.add('show');
    $('#ovBtn').textContent = 'ë¬´ë£Œ ìˆ˜ë ¹';
    $('#ovBtn').onclick = () => {
      state.wallet.gold += g;
      state.wallet.freeCash += f;
      state.wallet.lastSeenAtMs = now();
      saveWallet();
      $('#overlay').classList.remove('show');
      $('#ovBtn').textContent = 'í™•ì¸';
      bindOverlayDefault();
      updateHUD();
      toast('ì˜¤í”„ë¼ì¸ ë³´ìƒ ìˆ˜ë ¹');
      playSfx('serve');
    };
  }

  function bindOverlayDefault(){
    $('#ovBtn').onclick = () => {
      $('#overlay').classList.remove('show');
      resetRound();
    };
  }

  function endGame(reason = 'ë¼ìš´ë“œ ì¢…ë£Œ'){
    if (state.ended) return;
    state.running = false;
    state.paused = false;
    state.ended = true;

    state.wallet.gold += state.runGold;
    const playedMin = Math.max(1, (state.totalMs - state.leftMs) / 60000);
    const perMin = state.runGold / playedMin;
    state.wallet.baseRPM = Math.max(80, Math.round(state.wallet.baseRPM * 0.8 + perMin * 0.2));
    state.wallet.lastSeenAtMs = now();
    saveWallet();

    $('#ovTitle').textContent = reason;
    $('#ovDesc').innerHTML = `íšë“ ê³¨ë“œ: <b>${state.runGold.toLocaleString()}</b><br>ì„œë¹™ ${state.served} / ì‹¤íŒ¨ ${state.missed}<br>baseRPM ê°±ì‹ : ${state.wallet.baseRPM}`;
    $('#overlay').classList.add('show');
    $('#ovBtn').textContent = 'ë‹¤ì‹œ í”Œë ˆì´';
    $('#ovBtn').onclick = () => {
      $('#overlay').classList.remove('show');
      resetRound();
      startGame();
    };

    updateHUD();
    renderStations();
    renderTray();
    renderCustomers();
    status('ë¼ìš´ë“œ ì¢…ë£Œ');
  }

  function resetRound(){
    state.running = false;
    state.paused = false;
    state.ended = false;
    state.leftMs = state.totalMs;
    state.lives = 3;
    state.combo = 0;
    state.runGold = 0;
    state.feverUntil = 0;
    state.served = 0;
    state.missed = 0;
    state.orders = [];
    state.orderSeq = 1;
    state.spawnCd = 1200;
    for (const k of KEYS){
      state.stations[k].busy = false;
      state.stations[k].left = 0;
      state.stations[k].total = 0;
      state.tray[k] = 0;
    }
    state.lastTs = 0;
    $('#pauseBtn').textContent = 'ì¼ì‹œì •ì§€';
    $('#overlay').classList.remove('show');
    renderCustomers();
    renderStations();
    renderTray();
    updateHUD();
    status('ì¤€ë¹„ ì™„ë£Œ. ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.');
  }

  function togglePause(){
    if (!state.running || state.ended) return;
    state.paused = !state.paused;
    $('#pauseBtn').textContent = state.paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
    status(state.paused ? 'ì¼ì‹œì •ì§€' : 'ì§„í–‰ ì¤‘');
  }

  function startGame(){
    if (state.running || state.ended) return;
    state.running = true;
    state.paused = false;
    $('#pauseBtn').textContent = 'ì¼ì‹œì •ì§€';
    if (state.orders.length === 0) { spawnOrder(); spawnOrder(); }
    status('ì˜ì—… ì‹œì‘! ì£¼ë¬¸ì„ ì²˜ë¦¬í•˜ì„¸ìš”.');
    renderCustomers();
    renderStations();
    renderTray();
    updateHUD();
    enableAudio();
    playSfx('start');
  }

  function status(text){ $('#status').textContent = text; }

  function pop(el, color){
    const r = el.getBoundingClientRect();
    burst(r.left + r.width / 2, r.top + r.height / 2, color);
    el.style.boxShadow = `0 0 0 2px ${color}66`;
    setTimeout(() => el.style.boxShadow = '', 180);
  }

  // -------- Audio --------
  function ensureAudio(){
    if (state.audioCtx) return true;
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return false;
    state.audioCtx = new AC();
    state.masterGain = state.audioCtx.createGain();
    state.masterGain.gain.value = 0.75;
    state.masterGain.connect(state.audioCtx.destination);
    return true;
  }
  function enableAudio(){
    if (!ensureAudio()) return;
    if (state.audioCtx.state === 'suspended') state.audioCtx.resume();
    if (state.audioOn) startBgm();
  }
  function tone(f, d = 0.09, type = 'triangle', v = 0.12, at = null){
    if (!state.audioCtx || !state.audioOn || !state.masterGain) return;
    const ctx = state.audioCtx;
    const t0 = at ?? ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(f, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(v, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + d);
    o.connect(g).connect(state.masterGain);
    o.start(t0); o.stop(t0 + d + 0.02);
  }
  function playSfx(kind){
    if (!state.audioCtx) return;
    const t = state.audioCtx.currentTime;
    if (kind === 'serve') {
      tone(660,.08,'triangle',.22,t); tone(920,.11,'sine',.18,t+.02);
    } else if (kind === 'miss') {
      tone(240,.12,'square',.22,t); tone(180,.14,'square',.18,t+.03);
    } else if (kind === 'done') {
      tone(760,.08,'triangle',.14,t);
    } else {
      tone(520,.07,'triangle',.12,t);
    }
  }
  const melody = [523.25,659.25,783.99,659.25,587.33,698.46,783.99,880.0];
  const bass = [130.81,146.83,164.81,196.0];
  function startBgm(){
    if (!state.audioOn || !state.audioCtx || state.bgmTimer) return;
    let idx = 0, b = 0;
    const playBlock = () => {
      const t = state.audioCtx.currentTime + 0.03;
      for (let i = 0; i < 8; i++) tone(melody[(idx + i) % melody.length], .19, 'sine', .09, t + i * 0.2);
      tone(bass[b % bass.length], .35, 'triangle', .08, t + .02);
      tone(bass[(b + 1) % bass.length], .35, 'triangle', .08, t + .82);
      idx = (idx + 2) % melody.length;
      b = (b + 1) % bass.length;
    };
    playBlock();
    state.bgmTimer = setInterval(playBlock, 1600);
  }
  function stopBgm(){
    if (state.bgmTimer){ clearInterval(state.bgmTimer); state.bgmTimer = null; }
  }

  // -------- Main Loop --------
  function loop(ts){
    if (!state.lastTs) state.lastTs = ts;
    const dt = ts - state.lastTs;
    state.lastTs = ts;

    if (state.running && !state.paused && !state.ended){
      state.leftMs -= dt;
      if (state.leftMs <= 0){
        state.leftMs = 0;
        endGame('ì˜ì—… ì¢…ë£Œ');
      }

      state.spawnCd -= dt;
      if (state.spawnCd <= 0){
        spawnOrder();
        state.spawnCd = 1200 + Math.random() * 2100;
      }

      for (let i = state.orders.length - 1; i >= 0; i--){
        const o = state.orders[i];
        o.left -= dt;
        if (o.left <= 0){
          state.orders.splice(i, 1);
          missOrder();
        }
      }

      for (const key of KEYS){
        const st = state.stations[key];
        if (!st.busy) continue;
        st.left -= dt;
        if (st.left <= 0) completeCook(key);
      }

      renderCustomers();
      renderStations();
      renderTray();
      updateHUD();
    }

    requestAnimationFrame(loop);
  }

  // -------- Events --------
  $('#pauseBtn').onclick = () => { enableAudio(); togglePause(); playSfx('start'); };
  $('#startBtn').onclick = () => {
    enableAudio();
    if (!state.running && !state.ended) startGame();
    else if (state.ended){ resetRound(); startGame(); }
  };
  $('#restartBtn').onclick = () => { enableAudio(); resetRound(); startGame(); };

  $('#soundBtn').onclick = () => {
    enableAudio();
    state.audioOn = !state.audioOn;
    $('#soundBtn').textContent = state.audioOn ? 'ğŸ”Š' : 'ğŸ”ˆ';
    if (state.audioOn){ startBgm(); playSfx('start'); toast('ì‚¬ìš´ë“œ ON'); }
    else { stopBgm(); toast('ì‚¬ìš´ë“œ OFF'); }
  };

  document.addEventListener('pointerdown', () => {
    enableAudio();
  }, { passive: true });

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) stopBgm();
    else if (state.audioOn) startBgm();
  });

  // -------- Boot --------
  state.wallet = loadWallet();
  updateHUD();
  renderCustomers();
  renderStations();
  renderTray();
  bindOverlayDefault();
  tryOfflineReward();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
